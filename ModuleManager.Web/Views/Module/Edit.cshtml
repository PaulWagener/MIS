@model ModuleManager.Web.ViewModels.ModuleEditViewModel

@{    
    HashSet<String> selected = new HashSet<string>();

    Model.Options.Filter(Model.Module);
}



<div class="container">
    <div class="row">
        <div id="primary">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    <li><a href="@Url.Action("Overview_Teacher_Temp", "Module")">Home</a></li>
                    <li class="active">Module bewerken</li>
                </ol>
            </div>

            <div class="col-md-12">
                <h2>Module bewerken</h2>
                <br />
            </div>

            <div class="col-md-12">
                @using (Html.BeginForm("Edit", "Module", FormMethod.Post, new { @id="module_edit_form" }))
                {
                    <div id="hidden-values">
                        @Html.HiddenFor(model => model.Module.CursusCode, new { @id = "cursuscode" });
                        @Html.HiddenFor(model => model.Module.Schooljaar, new { @id = "schooljaar" });

                        <div id="hidden-leerlijnen">

                        </div>

                        <div id="hidden-voorkennis">
                        </div>
                    </div>

                    <table class="table">
                        <tr>
                            <td><label for="tags">Naam</label></td>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" class="form-control" id="name" placeholder="Naam" value="@Model.Module.Naam" disabled="disabled">
                            </td>
                        </tr>
                    </table>                    
                
                    <table class="table">
                        <tr>
                            <td><label for="tags">Beschrijving</label></td>
                        </tr>
                        <tr>
                            <td>
                                <textarea class="form-control" id="description" placeholder="Beschrijving">@Model.Module.Beschrijving</textarea>
                            </td>
                        </tr>
                    </table>                    

                    <table style="width:100%;" class="table">
                        <tr>
                            <td><label>Competentie</label></td>
                            <td style="width:20%"><label>Niveau</label></td>
                        </tr>
                        <tr>
                            <td>
                                @Html.DropDownList("ModuleCompetentie", new MultiSelectList(Model.Options.Competenties, "Naam", "Naam", Model.Module.ModuleCompetentie.Select(m => m.Competentie.Naam)), new { @id = "competenties", @multiple = "form-control", @class = "form-control" })

                            </td>
                            <td>
                                @Html.DropDownList("Niveau", new MultiSelectList(Model.Options.Niveaus, "Niveau1", "Niveau1"), new { @class = "form-control" })
                            </td>
                        </tr>
                    </table>    
                
                    <table class="table">
                        <tr>
                            <td><label>Leerlijnen</label></td>
                        </tr>
                        <tr>
                            <td>
                                @Html.DropDownList("Leerlijn", new MultiSelectList(Model.Options.Leerlijnen, "Naam", "Naam", Model.Module.Leerlijn.Select(m => m.Naam)), new { @id = "leerlijn", @multiple = "multiple", @class = "form-control" })
                            </td>
                        </tr>
                    </table>
                    
                    <table class="table">
                        <tr>
                            <td><label for="voorkennis">Voorkennis</label></td>
                        </tr>
                        <tr>
                            <td>
                                @Html.DropDownList("Voorkennis", new MultiSelectList(Model.Options.VoorkennisModules, "Naam", "Naam", Model.Module.Module2.Select(m => m.Naam)), new { @id = "voorkennis", @multiple = "multiple", @class = "form-control" }) 
                            </td>
                        </tr>
                    </table>

                    <div class="form-group">
                        <label for="general-information">Algemene informatie</label>
                        <table class="table table-bordered table-center table-striped">
                            <tbody>
                                <tr>
                                    <th style="min-width: 250px;"><label for="werkvorm">Werkvorm</label></th>
                                    <td>
                                        <select name="werkvorm" class="form-control" id="werkvorm" multiple>
                                            <option></option>
                                            @foreach (var werkvorm in Model.Module.ModuleWerkvorm)
                                            {
                                                    <option data-type="@werkvorm.WerkvormType" selected="selected"> (@werkvorm.WerkvormType)</option>
                                            }
                                            @foreach (var opt in Model.Options.Werkvormen)
                                            {
                                                <option data-type="@opt.Type" selected="selected"> @opt.Omschrijving (@opt.Type)</option>
                                            }
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Tags</th>
                                    <td>
                                        <table class="table table-bordered" id="wp">
                                            <thead>
                                                <tr>
                                                    <th>Tag</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.Module.Tag.Count; i++)
                                                {
                                                    <tr>
                                                        <td>
                                                            @Html.DropDownListFor(item => Model.Module.Tag[i].Naam, new SelectList((from t in Model.Options.Tags select t.Naam), Model.Module.Tag[i].Naam), new { @class = "form-control" })                                                           
                                                        </td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                        <button data-options='@Html.Raw(Json.Encode(from t in Model.Options.Tags select t.Naam))' data-target="wp" data-columns="1" data-collectionname="Tag" data-properties='["Naam"]' data-nextindex="@Model.Module.Tag.Count" class="btn btn-success btn-sm row_add" type="button"><i class="fa fa-plus"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Organisatie</th>
                                    <td>
                                        <table class="table table-bordered" id="organisatie">
                                            <thead>
                                                <tr>
                                                    <th width="20px">Werkvorm</th>
                                                    <th>Organisatie</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var werkvorm in Model.Module.ModuleWerkvorm)
                                                {
                                                    <tr>
                                                        <td>@Html.EditorFor(item => werkvorm.WerkvormType, new { htmlAttributes = new { @class = "form-control", @disabled = "disabled" } })</td>
                                                        <td>@Html.EditorFor(item => werkvorm.Organisatie, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Studiebelasting</th>
                                    <td>
                                        <table class="table table-bordered" id="sb">
                                            <thead>
                                                <tr>
                                                    <th>Activiteit</th>
                                                    <th>Duur</th>
                                                    <th>Frequentie</th>
                                                    <th>SBU</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                @for (int i = 0; i < Model.Module.StudieBelasting.Count; i++)
                                                {
                                                    <tr>
                                                        <td>@Html.EditorFor(item => Model.Module.StudieBelasting[i].Activiteit, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td>@Html.EditorFor(item => Model.Module.StudieBelasting[i].Duur, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td>@Html.EditorFor(item => Model.Module.StudieBelasting[i].Frequentie, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td>@Html.EditorFor(item => Model.Module.StudieBelasting[i].SBU, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.StudieBelasting[i].CursusCode, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.StudieBelasting[i].Schooljaar, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                        <button data-target="sb" data-columns="4" data-collectionname="StudieBelasting" data-properties='["Activiteit", "Duur", "Frequentie", "SBU"]' data-nextindex="@Model.Module.Leermiddelen.Count" class="btn btn-success btn-sm row_add" type="button"><i class="fa fa-plus"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Weekplanning</th>
                                    <td>
                                        <table class="table table-bordered" id="wp">
                                            <thead>
                                                <tr>
                                                    <th>Week</th>
                                                    <th>Onderwerpen</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.Module.Weekplanning.Count; i++)
                                                {
                                                    <tr>
                                                        <td style="width:80px;">@Html.EditorFor(item => Model.Module.Weekplanning[i].Week, new { htmlAttributes = new { @class = "form-control" } })</td>
                                                        <td>
                                                            @Html.EditorFor(item => Model.Module.Weekplanning[i].Onderwerp, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Weekplanning[i].CursusCode, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Weekplanning[i].Schooljaar, new { htmlAttributes = new { @class = "form-control" } })
                                                    </td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                            <tr>
                                                <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                    <button data-target="wp" data-columns="2" data-collectionname="Weekplanning" data-properties='["Week", "Onderwerp"]' data-nextindex="@Model.Module.Weekplanning.Count" class="btn btn-success btn-sm row_add" type="button"><i class="fa fa-plus"></i></button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Beoordeling</th>
                                    <td>
                                        <table class="table table-bordered" id="beoordelingen">
                                            <thead>
                                                <tr>
                                                    <th>Beoordelingen</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.Module.Beoordelingen.Count; i++)
                                                {
                                                    <tr>
                                                        <td>
                                                            @Html.EditorFor(item => Model.Module.Beoordelingen[i].Beschrijving, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Beoordelingen[i].CursusCode, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Beoordelingen[i].Schooljaar, new { htmlAttributes = new { @class = "form-control" } })
                                                    </td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                        <button data-target="beoordelingen" data-columns="1" data-collectionname="Weekplanning" data-properties='["Beschrijving"]' data-nextindex="@Model.Module.Beoordelingen.Count" class="btn btn-success row_add" type="button"><i class="fa fa-plus"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Leermiddelen</th>
                                    <td>
                                        <table class="table table-bordered" id="leermiddelen">
                                            <thead>
                                                <tr>
                                                    <th>Leermiddelen</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.Module.Leermiddelen.Count; i++)
                                                {
                                                    <tr>
                                                        <td>
                                                            @Html.EditorFor(item => Model.Module.Leermiddelen[i].Beschrijving, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Leermiddelen[i].CursusCode, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Leermiddelen[i].Schooljaar, new { htmlAttributes = new { @class = "form-control" } })
                                                    </td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                                <tr class=".leermiddel_add">
                                                    <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                        <button data-target="leermiddelen" data-columns="1" data-collectionname="Leermiddelen" data-properties='["Beschrijving"]' data-nextindex="@Model.Module.Leermiddelen.Count" class="btn btn-success row_add" type="button"><i class="fa fa-plus"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Leerdoelen</th>
                                    <td>
                                        <table class="table table-bordered" id="leerdoelen">
                                            <thead>
                                                <tr>
                                                    <th>Een student kan...</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.Module.Leerdoelen.Count; i++)
                                                {
                                                    <tr>
                                                        <td>
                                                            @Html.EditorFor(item => Model.Module.Leerdoelen[i].Beschrijving, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Leerdoelen[i].CursusCode, new { htmlAttributes = new { @class = "form-control" } })
                                                        @Html.HiddenFor(item => Model.Module.Leerdoelen[i].Schooljaar, new { htmlAttributes = new { @class = "form-control" } })
                                                    </td>
                                                        <td style="width: 90px; text-align:center">
                                                            <a class="btn btn-danger btn-sm remove_row"><i class="fa fa-trash"></i></a>
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td style="width: 90px; text-align:right; padding-right:30px" colspan="5">
                                                        <button data-target="leerdoelen" data-columns="1" data-collectionname="Leerdoelen" data-properties='["Beschrijving"]' data-nextindex="@Model.Module.Leerdoelen.Count" class="btn btn-success row_add" type="button"><i class="fa fa-plus add_row"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                
                            </tbody>
                        </table>
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <div id="status" class="checkbox" style="padding-left: 10px;">
                            <label>
                                @if (Model.Module.IsCompleted)
                                {
                                    <input name="status" type="checkbox" checked="checked">
                                }
                                else
                                {
                                    <input name="status" type="checkbox">
                                }
                                Compleet?
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg">Opslaan</button>
                    <a href="@Url.Action("Overview_Teacher_Temp", "Module")" class="btn btn-default">Annuleren</a>

                }
            </div>
        </div>
    </div>
</div>

<!-- Help MODAL-->
@Html.Partial("~/Views/Help/ModuleEdit.cshtml", null);

<!-- JAVA MEUK -->
@section Scripts {
    <script>



        function AddRow(targettable, values) {
            var target = $("#" + targettable + " > tbody");

            newRow = "<tr>";

            for (var i = 0; i < values.length; i++) {
                newRow += "<td>" + values[i] + "</td>";
            }

            newRow += "<td style='width: 90px;'>" +
            "<a class='btn btn-warning btn-sm'><i class='fa fa-pencil'></i></a>" +
            "<a class='btn btn-danger btn-sm'><i class='fa fa-trash'></i></a>" +
        "</td>";

            newRow += "<tr>";

            target.append(newRow);
        }

        
        $("#competenties").on("select2-selecting", function (e) {
            var niveau = $("#niveaus:selected").val();
            var currentVal = $(this).val();

            $(this).val(currentVal + " (" + niveau + ")");
        });

        $("#werkvorm").on("select2-selecting", function (e) {
            var selected = $("#werkvorm:selected").data("type");

            debugger;
            var newRow = "<tr><td><input class='form-control text-box single-line' disabled='disabled' id='werkvorm_WerkvormType' name='werkvorm.WerkvormType' type='text' value='" + $(this).data("type") + "'></td><td><input class='form-control text-box single-line' id='werkvorm_Organisatie' name='werkvorm.Organisatie' type='text'></td>";

            newRow += "<td style='width: 90px; text-align:center'>" +
            "<a class='btn btn-danger btn-sm remove_row'><i class='fa fa-trash'></i></a>" +
            "</td>";

            newRow += "</tr>";

            $("#organisatie tr:last").after(newRow);
        }).on("select2-removed", function (e) {
            //alert("removed val=" + e.data("type") + " choice=" + e.choice.text);
        })

        $("#module_edit_form").submit(function () {
            $hidden_leerlijnen = $("#hidden-leerlijnen");
            $hidden_voorkennis = $("#hidden-voorkennis");

            $hidden_leerlijnen.empty();

            var index = 0;
            debugger;
            $("#leerlijn option:selected").each(function (i, selected) {
                
                var newRow1 = "<input name='Module.Tag[" + index + "].Naam' type='hidden' value=" + $(selected).text() + ">";
                var newRow2 = "<input name='Module.Tag[" + index + "].Schooljaar' type='hidden' value='@Model.Module.Schooljaar'>";

                $hidden_leerlijnen.append(newRow1 + newRow2);

                ++index;
            });

            index = 0;

            $("#voorkennis option:selected").each(function (i, selected) {

                var newRow1 = "<input name='Module.Module2[" + index + "].Naam' type='hidden' value=" + $(selected).text() + ">";
                var newRow2 = "<input name='Module.Module2[" + index + "].Schooljaar' type='hidden' value='@Model.Module.Schooljaar'>";
                var newRow3 = "<input name='Module.Module2[" + index + "].CursusCode' type='hidden' value='@Model.Module.CursusCode'>";

                $hidden_voorkennis.append(newRow1 + newRow2 + newRow3);

                ++index;
            });
        });

        $(".row_add").click(function () {
            
            var target = $(this).data("target");            
            var columns = $(this).data("columns");            
            var collName = $(this).data("collectionname");            
            var properties = $(this).data("properties");
            var newIndex = $(this).data("nextindex")

            var options = $(this).data("options");

            
            
            var newRow = "<tr>";
            if (columns == properties.length) {
                if (columns == 1 && typeof(options) != 'undefined' )
                {
                    debugger;
                    newRow += "<td><select>";
                    for (var optionName in options)
                    {
                        newRow += "<option>" + optionName + "</option>"
                    }
                    newRow += "</select>"
                }
                else
                {
                    for (var i = 0; i < columns; i++)
                    {
                        newRow += "<td><input class='form-control' id='Module_" + collName + "_" + newIndex + "_" + properties[i] + "' name='Module." + collName + "[" + newIndex + "]." + properties[i] + "' type='text'>"

                        if (i != (columns - 1))
                            newRow += "</td>";
                    }
                }
            }
            
            newRow += "<input id='Module_" + collName + "_" + newIndex + "__CursusCode' name='Module." + collName + "[" + newIndex + "].CursusCode' type='hidden' value='@Model.Module.CursusCode'>";
            newRow += "<input id='Module_" + collName + "_" + newIndex + "__Schooljaar' name='Module." + collName + "[" + newIndex + "].Schooljaar' type='hidden' value='@Model.Module.Schooljaar'>";

            newRow += "</td>"

            newRow += "<td style='width: 90px; text-align:center'><a class='btn btn-danger btn-sm remove_row'><i class='fa fa-trash'></i></a></td>"

            newRow += "</tr>";
            
            $("#" + target + " tr:last").before(newRow);

            $(this).data("nextindex", newIndex + 1);
        });

        $(document).on("click", ".remove_row", function () {
            $(this).closest("tr").remove()
        });

        $(function () {
            // SELECT2
            $("#competenties").select2({
                placeholder: "Competenties"
            });

            $("#leerlijn").select2({
                placeholder: "Leerlijn"
            });

            $("#tags").select2({
                placeholder: "Tags"
            });

            $("#werkvorm").select2({
                placeholder: "Werkvorm"
            });

            $("#voorkennis").select2({
                placeholder: "Werkvorm"
            });
        });
    </script>
}